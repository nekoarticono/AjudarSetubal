<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="site.css">
<title>Reporta Cidade - Demo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.5/dist/umd/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://ndxcyrryiwbvzyzkrath.supabase.co";
  const SUPABASE_KEY = "sb_publishable_meHimVyAEGOxBkEN5kecMQ_Ua-4SaA6";

  window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<style>
/* ======= GLOBAL ======= */

</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="header-left">
    <button id="toggleSidebar" class="lang-btn">üìã</button>
    <div class="brand">Cidade de Set√∫bal</div>
  </div>
  <div class="header-right">
    <div class="setubal-box" style="background:transparent;border:2px solid rgba(255,255,255,0.2);padding:6px 12px;border-radius:6px;">Set√∫bal.</div>
    <button id="langToggle" class="lang-btn" aria-pressed="false">EN</button>
  </div>
</div>
<!-- SUBMENU -->
<div id="submenu">
  <div id="s-help"><strong>AjudaSet√∫bal</strong></div>
  <a href="index.html"><button id="btnVoltar" class="menu-btn">üè† Voltar</button></a>
</div>

<!-- MAP -->
<div id="map" role="application" aria-label="Mapa interativo"></div>

<!-- SIDEBAR -->
<div id="sidebar" aria-live="polite">
    <h2 id="sidebarTitle">üìç Ocorr√™ncias</h2>
    <div id="listaOcorrencias" aria-atomic="true"></div>
</div>

<!-- FIREBASE MODULE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// Limites do mapa (Set√∫bal)
const boundsSetubal = L.latLngBounds(
  [38.505, -8.945],
  [38.555, -8.835]
);

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBszOxK6XF7AduMHSvZKzlX-JlTAxRarPM",
  authDomain: "piajudasetubal.firebaseapp.com",
  projectId: "piajudasetubal",
  messagingSenderId: "306664959034",
  appId: "1:306664959034:web:41471ccba219bb93cb1903",
  measurementId: "G-LS56EN7H4M"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const storage = getStorage(app);

// Supabase
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// Fun√ß√£o para upload de imagens no Supabase
async function uploadImagemSupabase(file) {
  const fileName = `${Date.now()}_${file.name}`;
  const { data, error } = await supabase.storage.from("imagens").upload(fileName, file);
  if (error) throw error;
  const { data: publicUrlData } = supabase.storage.from("imagens").getPublicUrl(fileName);
  return publicUrlData.publicUrl;
}

// Tornar Firebase e Supabase globais
window.db = db;
window.storage = storage;
window.addDoc = addDoc;
window.collection = collection;
window.getDocs = getDocs;
window.ref = ref;
window.uploadBytes = uploadBytes;
window.getDownloadURL = getDownloadURL;
window.uploadImagemSupabase = uploadImagemSupabase;

// Tradu√ß√£o e textos
const TEXTS = {
  pt: {
    langLabel: 'EN',
    headerBrand: 'Cidade de Set√∫bal',
    submenu: { help: 'AjudaSet√∫bal' },
    sidebarTitle: 'üìç Ocorr√™ncias',
    newOccurrenceTitle: 'üìù Nova ocorr√™ncia',
    labels: { titulo: 'T√≠tulo', categoria: 'Categoria', descricao: 'Descri√ß√£o', foto: 'Foto', guardar: 'üíæ Guardar', registada: 'Registada', chooseFile: 'Escolher ficheiro', noFile: 'Nenhum ficheiro' },
    categories: ['Animais','Higiene e Limpeza','Ilumina√ß√£o P√∫blica','Parques e Jardins','Praias e Espa√ßos Verdes','Sinaliza√ß√£o e Tr√¢nsito']
  },
  en: {
    langLabel: 'PT',
    headerBrand: 'City of Set√∫bal',
    submenu: { help: 'AjudaSet√∫bal'},
    sidebarTitle: 'üìç Incidents',
    newOccurrenceTitle: 'üìù New incident',
    labels: { titulo: 'Title', categoria: 'Category', descricao: 'Description', foto: 'Photo', guardar: 'üíæ Save', registada: 'Registered', chooseFile: 'Choose file', noFile: 'No file' },
    categories: ['Animals','Hygiene & Cleaning','Public Lighting','Parks & Gardens','Beaches & Green Areas','Signage & Traffic']
  }
};

let lang = 'pt';
let map, markersGroup;
let ocorrencias = [];
let currentPopup = null;

document.addEventListener('DOMContentLoaded', () => {

  document.addEventListener('DOMContentLoaded', () => {
  const listaOcorrencias = document.getElementById('listaOcorrencias');
  const sidebar = document.getElementById('sidebar');

  // bot√£o que s√≥ aparece no mobile
  const mobileOcorrenciasBtn = document.createElement('button');
  mobileOcorrenciasBtn.textContent = 'üìç Minhas Ocorr√™ncias';
  mobileOcorrenciasBtn.style.padding = '8px 12px';
  mobileOcorrenciasBtn.style.margin = '10px';
  mobileOcorrenciasBtn.style.cursor = 'pointer';

  // adicionar no topo do header ou onde quiser no mobile
  const headerRight = document.querySelector('.header-right');
  headerRight.appendChild(mobileOcorrenciasBtn);

  // fun√ß√£o de mostrar/esconder ocorr√™ncias
  mobileOcorrenciasBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // impede fechar ao clicar
    if (listaOcorrencias.style.display === 'block') {
      listaOcorrencias.style.display = 'none';
    } else {
      listaOcorrencias.style.display = 'block';
      sidebar.classList.add('open'); // garante que o sidebar abre
    }
  });

  // fecha sidebar e lista se clicar fora
  document.addEventListener('click', (e) => {
    if (!sidebar.contains(e.target) && e.target !== mobileOcorrenciasBtn) {
      sidebar.classList.remove('open');
      listaOcorrencias.style.display = 'none';
    }
  });

  // impede que clique dentro do sidebar feche
  sidebar.addEventListener('click', (e) => e.stopPropagation());
});
  // Inicializa mapa
  map = L.map("map", {
    zoomControl: false,
    minZoom: 15,
    maxZoom: 19,
    maxBounds: boundsSetubal,
    maxBoundsViscosity: 1.0
    
  }).setView([38.52888, -8.88597], 15);
    L.control.zoom({
      position: 'topright'
       }).addTo(map);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
  markersGroup = L.layerGroup().addTo(map);

  // Eventos para popup
  map.on('popupopen', (e) => { currentPopup = e.popup.getElement(); });
  map.on('popupclose', (e) => { currentPopup = null; });

  // √çcone padr√£o
  const icon = L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize: [38, 38], iconAnchor: [19, 38] });

  // Bot√£o sidebar
  const toggleSidebarBtn = document.getElementById('toggleSidebar');
  const sidebar = document.getElementById('sidebar');
  toggleSidebarBtn.addEventListener('click', () => sidebar.classList.toggle('open'));

  // Alternar linguagem
  const langToggle = document.getElementById('langToggle');
  langToggle.addEventListener('click', () => {
    lang = (lang === 'pt') ? 'en' : 'pt';
    langToggle.setAttribute('aria-pressed', lang === 'en');
    applyLanguage();
    
  });
  applyLanguage();

  function applyLanguage() {
    const t = TEXTS[lang];
    document.querySelector('.brand').textContent = t.headerBrand;
    document.getElementById('s-help').innerHTML = `<strong>${t.submenu.help}</strong>`;
    document.getElementById('sidebarTitle').textContent = t.sidebarTitle;
    renderLista();
    renderPins();
  }

  function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }

  function getFormHTML(lat, lng) {
    const id = Date.now();
    return `
      <div style="min-width:260px">
        <h4>üìù Nova ocorr√™ncia</h4>
        <label>T√≠tulo</label>
        <input id="titulo-${id}" type="text" placeholder="T√≠tulo">
        <label>Categoria</label>
        <select id="categoria-${id}">
          <option>Animais</option><option>Higiene e Limpeza</option>
          <option>Ilumina√ß√£o P√∫blica</option><option>Parques e Jardins</option>
          <option>Praias e Espa√ßos Verdes</option><option>Sinaliza√ß√£o e Tr√¢nsito</option>
        </select>
        <label>Descri√ß√£o</label>
        <textarea id="descricao-${id}" rows="3" placeholder="Descri√ß√£o"></textarea>
        <label>Foto</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="foto-${id}" type="file" accept="image/*">
        </div>
        <img id="preview-${id}" class="preview-img" src="https://via.placeholder.com/400x240?text=Preview" alt="preview"/>
        <button class="save-btn" onclick="guardarOcorrencia(${lat}, ${lng}, ${id})">üíæ Guardar</button>
      </div>
    `;
  }

  map.on("click", e => {
    const html = getFormHTML(e.latlng.lat, e.latlng.lng);
    L.popup({ maxWidth: 380 }).setLatLng(e.latlng).setContent(html).openOn(map);
  });

  map.on('popupopen', function(e) {
    const popupEl = e.popup.getElement();
    const fileInput = popupEl.querySelector('input[type="file"]');
    const preview = popupEl.querySelector('img.preview-img');
    if (!fileInput) return;
    fileInput.addEventListener('change', (ev) => {
      const f = ev.target.files[0];
      if (!f) { preview.src = 'https://via.placeholder.com/400x240?text=Preview'; return; }
      const reader = new FileReader();
      reader.onload = (evt) => { preview.src = evt.target.result; };
      reader.readAsDataURL(f);
    });
  });

  // ===== Fun√ß√µes principais =====
  async function guardarOcorrencia(lat, lng, uniqueId) {
    try {
      const username = localStorage.getItem("username");
      const userUID = localStorage.getItem("userUID");
      if (!userUID) throw new Error("√â necess√°rio fazer login para reportar ocorr√™ncias.");

      let tituloEl = document.getElementById(`titulo-${uniqueId}`);
      let categoriaEl = document.getElementById(`categoria-${uniqueId}`);
      let descricaoEl = document.getElementById(`descricao-${uniqueId}`);
      let fotoEl = document.getElementById(`foto-${uniqueId}`);

      const titulo = (tituloEl.value || "").trim();
      const categoria = (categoriaEl.value || "").trim();
      const descricao = (descricaoEl.value || "").trim();
      const fotoFile = fotoEl && fotoEl.files && fotoEl.files[0];

      if (!titulo || !categoria || !descricao) throw new Error("Preencha todos os campos.");

      let fotoURL = "https://via.placeholder.com/400";

      if (fotoFile) {
        const fileName = `${Date.now()}_${fotoFile.name}`;
        const { data, error } = await supabase.storage.from('imagems_reportes').upload(fileName, fotoFile);
        if (error) throw error;
        fotoURL = supabase.storage.from('imagems_reportes').getPublicUrl(fileName).data.publicUrl;
      }

      await addDoc(collection(db, "registros"), {
        titulo, categoria, descricao, foto: fotoURL,
        lat, lng, data: new Date().toISOString(),
        userUID
      });

      alert("Ocorr√™ncia guardada com sucesso!");
      map.closePopup();
      carregarOcorrencias();

    } catch (err) {
      console.error(err);
      alert("Erro: " + (err.message || err));
    }
  }
  window.guardarOcorrencia = guardarOcorrencia;

  async function carregarOcorrencias() {
    try {
      const userUID = localStorage.getItem("userUID");
      if (!userUID) return;

      const querySnapshot = await getDocs(collection(db, "registros"));
      ocorrencias = [];

      querySnapshot.forEach(doc => {
        const data = doc.data();
        if (data.userUID === userUID) {
          ocorrencias.push({
            titulo: data.titulo,
            categoria: data.categoria,
            descricao: data.descricao,
            foto: data.foto || "https://via.placeholder.com/400",
            lat: data.lat,
            lng: data.lng
          });
        }
      });

      renderLista();
      renderPins();
    } catch (err) {
      console.error("Erro ao carregar ocorr√™ncias:", err);
    }
  }

  function renderLista() {
    const div = document.getElementById('listaOcorrencias');
    div.innerHTML = '';
    const t = TEXTS[lang];
    ocorrencias.forEach(o => {
      const card = document.createElement('div');
      card.className = 'ocorrencia';
      card.innerHTML = `
        <img class="thumb" src="${o.foto}" alt="foto"/>
        <h3>${o.titulo}</h3>
        <p>${o.descricao}</p>
        <span class="estado">${t.labels.registada}</span>
      `;
      div.appendChild(card);
      card.addEventListener('click', () => map.setView([o.lat, o.lng], 18));
    });
  }

  function renderPins() {
    if (!markersGroup) return;
    markersGroup.clearLayers();
    ocorrencias.forEach(o => {
      const m = L.marker([o.lat, o.lng], { icon: icon }).addTo(markersGroup);
      m.bindPopup(`
        <strong>${escapeHtml(o.titulo)}</strong><br>
        ${escapeHtml(o.descricao)}<br>
        <img src="${o.foto}" style="width:100%;margin-top:5px"/>
      `);
    });
  }

  carregarOcorrencias();
});
</script>

</body>
</html>
